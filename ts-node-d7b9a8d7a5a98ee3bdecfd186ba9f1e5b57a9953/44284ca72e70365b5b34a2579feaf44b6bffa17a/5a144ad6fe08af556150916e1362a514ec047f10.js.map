{"version":3,"file":"/home/hdthinh/wthapps/portal-frontend/tools/tasks/seed/build.html_css.ts","sources":["/home/hdthinh/wthapps/portal-frontend/tools/tasks/seed/build.html_css.ts"],"names":[],"mappings":"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","sourcesContent":["import * as autoprefixer from 'autoprefixer';\nimport * as cssnano from 'cssnano';\nimport * as gulp from 'gulp';\nimport * as gulpLoadPlugins from 'gulp-load-plugins';\nimport * as merge from 'merge-stream';\nimport * as util from 'gulp-util';\nimport * as filter from 'gulp-filter';\nimport { join } from 'path';\n\nimport Config from '../../config';\nimport { CssTask } from '../css_task';\n\nconst plugins = <any>gulpLoadPlugins();\nconst gulpConcatCssConfig = Config.getPluginConfig('gulp-concat-css');\n\nconst processors = [\n  autoprefixer({\n    browsers: Config.BROWSER_LIST\n  })\n];\n\nconst reportPostCssError = (e: any) => util.log(util.colors.red(e.message));\n\nconst isProd = Config.BUILD_TYPE === 'prod';\n\nif (isProd) {\n  processors.push(\n    cssnano({\n      discardComments: {removeAll: true},\n      discardUnused: false, // unsafe, see http://goo.gl/RtrzwF\n      zindex: false, // unsafe, see http://goo.gl/vZ4gbQ\n      reduceIdents: false // unsafe, see http://goo.gl/tNOPv0\n    })\n  );\n}\n\nconst appSCSSFiles      = join(Config.APP_SRC, '**', '*.scss');\nconst entrySCSSFiles    = join(Config.CSS_SRC, '**', '*.scss');\nconst abtractSCSSFiles  = join(Config.SCSS_SRC, '**', '*.scss');\n\n/**\n * Copies all HTML files in `src/client` over to the `dist/tmp` directory.\n */\nfunction prepareTemplates() {\n  return gulp.src(join(Config.APP_SRC, '**', '*.html'))\n    .pipe(gulp.dest(Config.TMP_DIR));\n}\n\n/**\n * Execute the appropriate component-stylesheet processing method based on user stylesheet preference.\n */\nfunction processComponentStylesheets() {\n  return Config.ENABLE_SCSS ?\n    merge(\n      processComponentScss(),\n      processComponentCss())\n    :\n    processComponentCss();\n}\n\n/**\n * Process scss files referenced from Angular component `styleUrls` metadata\n */\nfunction processComponentScss() {\n  return getSCSSFiles('process-component-scss', [appSCSSFiles], [abtractSCSSFiles])\n    .pipe(plugins.sourcemaps.init())\n    .pipe(plugins.sass(Config.getPluginConfig('gulp-sass')).on('error', plugins.sass.logError))\n    .pipe(plugins.postcss(processors))\n    .on('error', reportPostCssError)\n    .pipe(plugins.sourcemaps.write(isProd ? '.' : '', {\n      sourceMappingURL: (file: any) => {\n        // write absolute urls to the map files\n        return `${Config.APP_BASE}${file.relative}.map`;\n      }\n    }))\n    .pipe(gulp.dest(isProd ? Config.TMP_DIR : Config.APP_DEST));\n}\n\n/**\n + * Get SCSS Files to process\n + */\nfunction getSCSSFiles(cacheName:string, filesToCompile:string[], filesToExclude:string[] = []) {\n  let allFiles:string[] = filesToCompile.concat(filesToExclude);\n  let filteredFiles:string[] = filesToCompile.concat(\n    filesToExclude.map((path:string) => { return '!' + path; })\n  );\n  return gulp.src(allFiles)\n    .pipe(plugins.cached(cacheName))\n    .pipe(plugins.progeny())\n    .pipe(filter(filteredFiles));\n}\n\n/**\n * Processes the CSS files within `src/client` excluding those in `src/client/assets` using `postcss` with the\n * configured processors.\n */\nfunction processComponentCss() {\n  return gulp.src([\n    join(Config.APP_SRC, '**', '*.css'),\n    '!' + join(Config.APP_SRC, 'assets', '**', '*.css')\n  ])\n    .pipe(isProd ? plugins.cached('process-component-css') : plugins.util.noop())\n    .pipe(plugins.postcss(processors))\n    .on('error', reportPostCssError)\n    .pipe(gulp.dest(isProd ? Config.TMP_DIR : Config.APP_DEST));\n}\n\n/**\n * Execute external-stylesheet processing method based on presence of --scss flag.\n */\nfunction processExternalStylesheets() {\n  return Config.ENABLE_SCSS ? processAllExternalStylesheets() : processExternalCss();\n}\n\n/**\n * Process scss stylesheets located in `src/client/css` and any css dependencies specified in\n * the global project configuration.\n */\nfunction processAllExternalStylesheets() {\n  return merge(getExternalCssStream(), getExternalScssStream())\n    .pipe(isProd ? plugins.concatCss(gulpConcatCssConfig.targetFile, gulpConcatCssConfig.options) : plugins.util.noop())\n    .pipe(plugins.postcss(processors))\n    .on('error', reportPostCssError)\n    .pipe(gulp.dest(Config.CSS_DEST));\n}\n\n/**\n * Get a stream of external css files for subsequent processing.\n */\nfunction getExternalCssStream() {\n  return gulp.src(getExternalCss())\n    .pipe(isProd ? plugins.cached('process-external-css') : plugins.util.noop());\n}\n\n/**\n * Get an array of filenames referring to all external css stylesheets.\n */\nfunction getExternalCss() {\n  return Config.DEPENDENCIES.filter(dep => /\\.css$/.test(dep.src)).map(dep => dep.src);\n}\n\n/**\n * Get a stream of external scss files for subsequent processing.\n */\nfunction getExternalScssStream() {\n  return getSCSSFiles('process-external-scss', getExternalScss(), [abtractSCSSFiles])\n    .pipe(plugins.sass(Config.getPluginConfig('gulp-sass')).on('error', plugins.sass.logError));\n}\n\n/**\n * Get an array of filenames referring to external scss stylesheets located in the global DEPENDENCIES\n * as well as in `src/css`.\n */\nfunction getExternalScss() {\n  return Config.DEPENDENCIES.filter(dep => /\\.scss$/.test(dep.src)).map(dep => dep.src)\n    .concat([entrySCSSFiles]);\n}\n\n/**\n * Processes the external CSS files using `postcss` with the configured processors.\n */\nfunction processExternalCss() {\n  return getExternalCssStream()\n    .pipe(plugins.postcss(processors))\n    .pipe(isProd ? plugins.concatCss(gulpConcatCssConfig.targetFile, gulpConcatCssConfig.options) : plugins.util.noop())\n    .on('error', reportPostCssError)\n    .pipe(gulp.dest(Config.CSS_DEST));\n}\n\n/**\n * Executes the build process, processing the HTML and CSS files.\n */\nexport =\n  class BuildHtmlCss extends CssTask {\n\n    shallRun(files: String[]) {\n      return super.shallRun(files) || files.some(f => f.endsWith('.html'));\n    }\n\n    run() {\n      return merge(processComponentStylesheets(), prepareTemplates(), processExternalStylesheets());\n    }\n  };\n"]}